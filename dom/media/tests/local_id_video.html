<html>
<head>
  <title>Simple WebRTC-BrowserID Test</title>
</head>
<body>

<h1>Simple WebRTC-BrowserID Test</h1>
<div><h3>Remote video:</h3><video id="tehvideo" height="480" width="640" controls></video></div><br/>
<div><button id="tehbutton" onClick="start();">Start!</button></div><br/>
<div id="log"></div>
<div><h3>Local video:</h3><video id="localvideo"></video></div><br/>

<script type="application/javascript;version=1.8">
  function log(msg) {
    let div = document.getElementById("log");
    div.innerHTML = div.innerHTML + "<p>" + msg + "</p>";
  }

  let video = document.getElementById("tehvideo");
  let button = document.getElementById("tehbutton");
  let localvideo = document.getElementById("localvideo");

  let pc1;
  let pc2;

  let pc1_offer;
  let pc2_answer;

  function failed(code) {
    log("Failure callback: " + code);
  }

  // pc1.createOffer finished, call pc1.setLocal
  function step1(offer) {
    pc1_offer = offer;
    pc1.setLocalDescription(offer, step2, failed);
  }

  // pc1.setLocal finished, call pc2.setRemote
  function step2() {
    log("Got offer from pc1 <br/>" + pc1_offer);
    pc2.setRemoteDescription(pc1_offer, step3, failed);
  };

  // pc2.setRemote finished, verify identity
  function step3() {
    pc2.verifyIdentity(pc1_offer, step4, failed);
  }

  // ID verified, call pc2.createAnswer
  function step4(identity) {
    log("pc2 verified identity for <b>" + identity.principal.email + "</b>" +
        " with fingerprint '" + identity.message + "'");
    pc2.createAnswer(pc1_offer, step5, failed);
  }

  // pc2.createAnswer finished, call pc2.setLocal
  function step5(answer) {
    pc2_answer = answer;
    pc2.setLocalDescription(answer, step6, failed);
  }

  // pc2.setLocal finished, call pc1.setRemote
  function step6() {
    log("Got answer from pc2 <br/>" + pc2_answer);
    pc1.setRemoteDescription(pc2_answer, step7, failed);
  }

  // pc1.setRemote finished, media should be running!
  function step7() {
    log("HIP HIP HOORAY");
  }

  function start() {
    button.innerHTML = "Stop!";
    button.onClick = stop;

    pc1 = new mozPeerConnection();
    pc1.onRemoteStreamAdded = function(obj) {
      log("pc1 got remote stream from pc2 " + obj.type);
    }

    pc2 = new mozPeerConnection();
    pc2.onRemoteStreamAdded = function(obj) {
      log("pc2 got remote stream from pc1 " + obj.type);
      if (obj.type == "video") {
        video.src = obj.stream;
        video.play();
      }
    }

    log("About to call getusermedia");
    navigator.mozGetUserMedia({video:true}, function(stream) {
      localvideo.src = stream;
      localvideo.play();

      pc1.addStream(stream);
      pc1.addStream(pc1.createFakeMediaStream("audio"));

      pc2.addStream(pc2.createFakeMediaStream("video"));
      pc2.addStream(pc2.createFakeMediaStream("audio"));

      // Select ID, then start the chain.
      pc1.selectIdentity(function() {
        log("pc1 selectIdentity finished successfully");
        pc1.createOffer(step1, failed);
      }, function(err) {
        log("pc1 got error from selectIdentity: " + err);
      });
    }, failed);
  }

  function stop() {
    pc1.close();
    pc2.close();

    button.innerHTML = "Start!";
    button.onClick = start;
  }
</script>

</html>
